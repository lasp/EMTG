<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PEATSAoven &#8212; EMTG python  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=61cd365c" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=12dfc556" />
    <script src="../_static/documentation_options.js?v=7f41d439"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for PEATSAoven</h1><div class="highlight"><pre>
<span></span><span class="c1">#EMTG: Evolutionary Mission Trajectory Generator</span>
<span class="c1">#An open-source global optimization tool for preliminary mission design</span>
<span class="c1">#Provided by NASA Goddard Space Flight Center</span>
<span class="c1">#</span>
<span class="c1">#Copyright (c) 2014 - 2024 United States Government as represented by the</span>
<span class="c1">#Administrator of the National Aeronautics and Space Administration.</span>
<span class="c1">#All Other Rights Reserved.</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2024 The Regents of the University of Colorado.</span>
<span class="c1"># All Other Rights Reserved.</span>

<span class="c1">#Licensed under the NASA Open Source License (the &quot;License&quot;); </span>
<span class="c1">#You may not use this file except in compliance with the License. </span>
<span class="c1">#You may obtain a copy of the License at:</span>
<span class="c1">#https://opensource.org/license/nasa1-3-php</span>
<span class="c1">#Unless required by applicable law or agreed to in writing, software</span>
<span class="c1">#distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1">#WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either </span>
<span class="c1">#express or implied.   See the License for the specific language</span>
<span class="c1">#governing permissions and limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">PEATSAoven.py</span>
<span class="sd">========================</span>
<span class="sd">This file contains the PEATSAoven class, which is used to execute PEATSA cases.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="c1">#PEATSAoven function</span>
<span class="c1">#function that runs all of the PEATSAdough (.emtgopt files) in the PEATSA meal</span>
<span class="c1">#and turns them into PEATSAcrusts (.emtg files)</span>
<span class="c1">#used to be step 2</span>
<span class="c1">#Jeremy Knittel 1/23/2018</span>

<span class="kn">import</span> <span class="nn">time</span>

<div class="viewcode-block" id="executeSingleRunInParallel">
<a class="viewcode-back" href="../PEATSA/PEATSAoven.html#PEATSAoven.executeSingleRunInParallel">[docs]</a>
<span class="k">def</span> <span class="nf">executeSingleRunInParallel</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">killfileName</span><span class="p">,</span> <span class="n">killTypeLineNumber</span><span class="p">,</span> <span class="n">devnull</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">logging</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">killfileName</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">killfileLines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="s2">&quot;killiteration_nopostprocess&quot;</span> <span class="ow">in</span> <span class="n">killfileLines</span><span class="p">[</span><span class="n">killTypeLineNumber</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;killrun_nopostprocess&quot;</span> <span class="ow">in</span> <span class="n">killfileLines</span><span class="p">[</span><span class="n">killTypeLineNumber</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="k">return</span>
        
    <span class="kn">import</span> <span class="nn">subprocess</span>

    <span class="n">sub</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">emtg_root_directory</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">executable_name</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">cases_directory</span> <span class="o">+</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough_path</span><span class="p">],</span><span class="n">stdout</span><span class="o">=</span><span class="n">devnull</span><span class="p">,</span><span class="n">stderr</span><span class="o">=</span><span class="n">devnull</span><span class="p">)</span>
    
    <span class="n">tStart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Started &#39;</span> <span class="o">+</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">cases_directory</span> <span class="o">+</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough_path</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1">#logging.info(&#39;Checking whether to exit for &#39; + PEATSAorder.cases_directory + box.PEATSAdough_path)</span>
        <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#logging.info(PEATSAorder.cases_directory + box.PEATSAdough_path + &#39; ended naturally&#39;)</span>
            <span class="k">break</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">killfileName</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">killfileLines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;killiteration_nopostprocess&quot;</span> <span class="ow">in</span> <span class="n">killfileLines</span><span class="p">[</span><span class="n">killTypeLineNumber</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;killrun_nopostprocess&quot;</span> <span class="ow">in</span> <span class="n">killfileLines</span><span class="p">[</span><span class="n">killTypeLineNumber</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="c1">#logging.info(PEATSAorder.cases_directory + box.PEATSAdough_path + &#39; was killed by killfile&#39;)</span>
            <span class="n">sub</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="k">break</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sub</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">tStart</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">killtime</span><span class="p">:</span>
                <span class="c1">#logging.info(PEATSAorder.cases_directory + box.PEATSAdough_path + &#39; was killed by timeout&#39;)</span>
                <span class="n">sub</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                <span class="k">break</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="executeSingleRunInParellelWithPebble">
<a class="viewcode-back" href="../PEATSA/PEATSAoven.html#PEATSAoven.executeSingleRunInParellelWithPebble">[docs]</a>
<span class="k">def</span> <span class="nf">executeSingleRunInParellelWithPebble</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span> <span class="n">box</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Routine to be run in parallel by a Pebble pool to execute an EMTG case</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    PEATSAorder : TYPE</span>
<span class="sd">        DESCRIPTION.</span>
<span class="sd">    box : TYPE</span>
<span class="sd">        DESCRIPTION.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="kn">import</span> <span class="nn">logging</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Started &#39;</span> <span class="o">+</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">cases_directory</span> <span class="o">+</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough_path</span><span class="p">)</span>
    <span class="n">systemCall</span> <span class="o">=</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">emtg_root_directory</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">executable_name</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">cases_directory</span> <span class="o">+</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough_path</span>
    <span class="n">runFlag</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">systemCall</span><span class="p">)</span>
    
    <span class="k">return</span></div>

    
<div class="viewcode-block" id="pebbleScheduledTaskDone">
<a class="viewcode-back" href="../PEATSA/PEATSAoven.html#PEATSAoven.pebbleScheduledTaskDone">[docs]</a>
<span class="k">def</span> <span class="nf">pebbleScheduledTaskDone</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">future</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Callback for pebble-based execution using schedule as opposed to map</span>
<span class="sd">    Taken from https://pypi.org/project/Pebble/</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="ne">TimeoutError</span>
    <span class="kn">import</span> <span class="nn">logging</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="c1"># blocks until results are ready</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough_path</span> <span class="o">+</span> <span class="s2">&quot; ended naturally&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Killed &quot;</span> <span class="o">+</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PEATSAoven.executeWithPebble encountered an error&quot;</span><span class="p">)</span>
        
    <span class="k">return</span></div>


<div class="viewcode-block" id="PEATSAoven">
<a class="viewcode-back" href="../PEATSA/PEATSAoven.html#PEATSAoven.PEATSAoven">[docs]</a>
<span class="k">class</span> <span class="nc">PEATSAoven</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used to execute PEATSA cases</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    None.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="PEATSAoven.writeKillFile">
<a class="viewcode-back" href="../PEATSA/PEATSAoven.html#PEATSAoven.PEATSAoven.writeKillFile">[docs]</a>
    <span class="k">def</span> <span class="nf">writeKillFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">killfileName</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the .DEATH file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        killfileName : String</span>
<span class="sd">            Directory + name of file in which to write the .DEATH file</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        KillTypeLineNumber : Integer</span>
<span class="sd">            The line number whose contents are checked to see if we need to kill the iteration.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">killfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">killfileName</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># increment after every \n. Do NOT increment after the final line where the user actually sets the input.</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# This file is used to end an iteration prematurely or an entire PEATSA run.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# The contents of this file are checked every 5 seconds while PEATSA is running EMTG cases.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# The contents of this file are NOT checked while PEATSA is doing python pre/post-processing.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# To change PEATSA behavior, change the value assigned to KillType and save the file.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Valid options for KillType are given below and are case-insensitive.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# None: (default) No effect. PEATSA continues normally.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# KillRun_NoPostProcess: Ends the entire PEATSA run. Does NOT run post-processing routines.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# KillIteration_NoPostProcess: End the current PEATSA iteration, then starts the next PEATSA iteration.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Does NOT run post-processing routines. This is useful if there is a midbake option you would like to have take effect immediately.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;KillType = None&quot;</span><span class="p">)</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">KillTypeLineNumber</span></div>

    
<div class="viewcode-block" id="PEATSAoven.executeWithPebble">
<a class="viewcode-back" href="../PEATSA/PEATSAoven.html#PEATSAoven.PEATSAoven.executeWithPebble">[docs]</a>
    <span class="k">def</span> <span class="nf">executeWithPebble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">PEATSAorder</span><span class="p">,</span> <span class="n">PEATSAboxes</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempt to parallelize with Pebble rather than subprocess or multiprocessing</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        PEATSAorder : PEATSAmenu object</span>
<span class="sd">            The options file for the run as a whole.</span>
<span class="sd">        PEATSAboxes : List of PEATSAbox objects</span>
<span class="sd">            Options for each individual run.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="kn">import</span> <span class="nn">logging</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Entering the PEATSA oven to run cases for Iteration &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">iteration</span><span class="p">))</span>
        
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">emtg_root_directory</span> <span class="o">+</span> <span class="s2">&quot;/PyEMTG&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">emtg_root_directory</span> <span class="o">+</span> <span class="s2">&quot;/PyEMTG/PEATSA&quot;</span><span class="p">)</span>
        
        <span class="kn">import</span> <span class="nn">pebble</span> <span class="c1"># for parallelization</span>
        <span class="kn">from</span> <span class="nn">pebble</span> <span class="kn">import</span> <span class="n">ProcessPool</span><span class="p">,</span> <span class="n">ProcessExpired</span><span class="p">,</span> <span class="n">concurrent</span>
        <span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="ne">TimeoutError</span>
        <span class="kn">import</span> <span class="nn">functools</span> <span class="c1"># for passing a single-arg function to pebble&#39;s pool.map()</span>
        <span class="kn">import</span> <span class="nn">PEATSAbox</span>
        
        <span class="c1"># Write out an iteration kill file</span>
        <span class="n">killfileName</span> <span class="o">=</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">+</span> <span class="s2">&quot;PEATSA_iteration_kill_file.DEATH&quot;</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">writeKillFile</span><span class="p">(</span><span class="n">killfileName</span><span class="p">)</span>
        
        <span class="n">devnull</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/dev/null&quot;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
            
        <span class="n">exe</span> <span class="o">=</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">emtg_root_directory</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">executable_name</span> <span class="c1"># the EMTG executable</span>
        <span class="n">nCases</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">PEATSAboxes</span><span class="p">)</span> <span class="c1"># number of cases we need to run</span>
        <span class="n">nCasesString</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">nCases</span><span class="p">)</span>
        <span class="n">nProcessors</span> <span class="o">=</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">nCores</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># number of parallel EMTGs to run</span>
        
        <span class="c1"># create a version of executeSingleRunInParellelWithPebble</span>
        <span class="c1"># that only requires a single input arg (the peatsabox)</span>
        <span class="n">executeSingleRunInParellelWithPebbleSingleArg</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">executeSingleRunInParellelWithPebble</span><span class="p">,</span> <span class="n">PEATSAorder</span><span class="p">)</span>
        <span class="n">runKill</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">tStart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="c1"># grab the current time</span>
        <span class="k">if</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">execution_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># using map</span>
            <span class="k">with</span> <span class="n">ProcessPool</span><span class="p">(</span><span class="n">max_workers</span> <span class="o">=</span> <span class="n">nProcessors</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="n">future</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">executeSingleRunInParellelWithPebbleSingleArg</span><span class="p">,</span> <span class="n">PEATSAboxes</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">killtime</span><span class="p">)</span>
                
                <span class="n">iterator</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">except</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Killed an EMTG&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">ProcessExpired</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;An EMTG exited&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PEATSAoven.executeWithPebble encountered an error&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">execution_type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># using schedule</span>
            <span class="k">with</span> <span class="n">ProcessPool</span><span class="p">(</span><span class="n">max_workers</span> <span class="o">=</span> <span class="n">nProcessors</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nCases</span><span class="p">):</span>
                    <span class="n">tCurrent</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">tCurrent</span> <span class="o">-</span> <span class="n">tStart</span> <span class="o">&gt;</span> <span class="mf">5.0</span><span class="p">):</span>
                        <span class="c1"># check the .death file every 5 seconds</span>
                        <span class="c1"># does the break command get us out of this loop so that we don&#39;t kick off anymore emtgs?</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">killfileName</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                        <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="k">if</span> <span class="s2">&quot;killiteration_nopostprocess&quot;</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">[</span><span class="n">KillTypeLineNumber</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Killing iteration&quot;</span><span class="p">)</span>
                            <span class="n">iterationKill</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">allCasesDone</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                        <span class="k">elif</span> <span class="s2">&quot;killrun_nopostprocess&quot;</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">[</span><span class="n">KillTypeLineNumber</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Killing iteration&quot;</span><span class="p">)</span>
                            <span class="n">runKill</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">allCasesDone</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">tStart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="c1"># reset the timer</span>
                        
                    <span class="c1"># schedule a job within the pool</span>
                    <span class="n">future</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">executeSingleRunInParellelWithPebbleSingleArg</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">PEATSAboxes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">killtime</span><span class="p">)</span>
                    
                    <span class="c1"># add a callback to be done when future is done</span>
                    <span class="n">future</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">pebbleScheduledTaskDone</span><span class="p">,</span> <span class="n">PEATSAboxes</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                    
        <span class="c1"># what to do if iterationKill or runKill:</span>
        <span class="k">if</span> <span class="n">runKill</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Killing PEATSA&quot;</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">()</span>
        
        <span class="k">return</span></div>

    
<div class="viewcode-block" id="PEATSAoven.executeV2">
<a class="viewcode-back" href="../PEATSA/PEATSAoven.html#PEATSAoven.PEATSAoven.executeV2">[docs]</a>
    <span class="k">def</span> <span class="nf">executeV2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">PEATSAorder</span><span class="p">,</span> <span class="n">PEATSAboxes</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">logging</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Entering the PEATSA oven to run cases for Iteration &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">iteration</span><span class="p">))</span>
        
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">emtg_root_directory</span> <span class="o">+</span> <span class="s2">&quot;/PyEMTG&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">emtg_root_directory</span> <span class="o">+</span> <span class="s2">&quot;/PyEMTG/PEATSA&quot;</span><span class="p">)</span>
        
        <span class="kn">import</span> <span class="nn">subprocess</span>
        <span class="c1">#import multiprocessing as mp</span>
        <span class="c1">#from multiprocessing.pool import ThreadPool</span>
        <span class="c1">#import MissionOptions</span>
        <span class="kn">import</span> <span class="nn">PEATSAbox</span>
        
        <span class="c1"># Write out an iteration kill file</span>
        <span class="n">killfileName</span> <span class="o">=</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">+</span> <span class="s2">&quot;PEATSA_iteration_kill_file.DEATH&quot;</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">writeKillFile</span><span class="p">(</span><span class="n">killfileName</span><span class="p">)</span>
        
        <span class="n">devnull</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/dev/null&quot;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
            
        <span class="n">exe</span> <span class="o">=</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">emtg_root_directory</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">executable_name</span> <span class="c1"># the EMTG executable</span>
        <span class="n">nCases</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">PEATSAboxes</span><span class="p">)</span> <span class="c1"># number of cases we need to run</span>
        <span class="n">nCasesString</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">nCases</span><span class="p">)</span>
        <span class="n">nProcessors</span> <span class="o">=</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">nCores</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># number of parallel EMTGs to run</span>
        <span class="n">nCasesRunning</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># keep track of the number of cases currently executing</span>
        <span class="n">mostRecentCase</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">iterationKill</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">runKill</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">allCasesDone</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">subs</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># list of current subprocesses. each element is also a list: [subprocess object, kickoff time, the options file that was executed]</span>
        <span class="n">tStart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="c1"># grab the current time</span>
        <span class="k">while</span> <span class="n">mostRecentCase</span> <span class="o">&lt;</span> <span class="n">nCases</span><span class="p">:</span>
            <span class="c1"># loop through all the cases that we need to run until they have all been kicked off</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="n">PEATSAboxes</span><span class="p">[</span><span class="n">mostRecentCase</span><span class="p">]</span><span class="o">.</span><span class="n">PEATSAdough_path</span>
            <span class="n">optionsFileToExecute</span> <span class="o">=</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">cases_directory</span> <span class="o">+</span> <span class="n">fileName</span> <span class="c1"># grab the next case to kick off</span>
            <span class="k">if</span> <span class="n">nCasesRunning</span> <span class="o">&lt;</span> <span class="n">nProcessors</span><span class="p">:</span>
                <span class="c1"># if we have a free processor, start a new case</span>
                <span class="n">subs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">exe</span><span class="p">,</span> <span class="n">optionsFileToExecute</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">devnull</span><span class="p">,</span><span class="n">stderr</span><span class="o">=</span><span class="n">devnull</span><span class="p">),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="n">optionsFileToExecute</span><span class="p">])</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting case &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mostRecentCase</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; of &quot;</span> <span class="o">+</span> <span class="n">nCasesString</span> <span class="o">+</span> <span class="s2">&quot; : &quot;</span> <span class="o">+</span> <span class="n">fileName</span><span class="p">)</span> <span class="c1"># use +1 because of 0-indexing</span>
                <span class="n">mostRecentCase</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># increment the most recent case</span>
                <span class="n">nCasesRunning</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># increment the number of cases currently running</span>
                
            <span class="n">subsToRemove</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># list of subprocesses to remove because they have ended</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">)):</span>
                <span class="c1"># figure out which subprocesses to remove</span>
                <span class="k">if</span> <span class="n">subs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># this means that the subprocess ended naturally of its own accord</span>
                    <span class="c1">#logging.info(&#39;Naturally ended: &#39; + subs[i][2])</span>
                    <span class="n">subsToRemove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">subs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">killtime</span><span class="p">:</span>
                    <span class="c1"># manually end process because it reached our killtime</span>
                    <span class="n">subsToRemove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    
            <span class="n">subsToRemove</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># sort indices of subs to remove from greatest to least so we remove the highest ones first so that pop() doesn&#39;t mess with our ordering</span>
            <span class="k">for</span> <span class="n">subToRemoveIndex</span> <span class="ow">in</span> <span class="n">subsToRemove</span><span class="p">:</span>
                <span class="c1"># remove subprocesses from the subs list</span>
                <span class="c1"># try removing the ones that ended naturally ... doesn&#39;t seem like they should need it, but do it anyway just in case</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">subs</span><span class="p">[</span><span class="n">subToRemoveIndex</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Killed &#39;</span> <span class="o">+</span> <span class="n">subs</span><span class="p">[</span><span class="n">subToRemoveIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Ended without killing: &#39;</span> <span class="o">+</span> <span class="n">subs</span><span class="p">[</span><span class="n">subToRemoveIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Ended without kill a process whose name we could not retrieve for some reason.&#39;</span><span class="p">)</span>
                
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">subs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">subToRemoveIndex</span><span class="p">)</span>
                    <span class="n">nCasesRunning</span> <span class="o">-=</span> <span class="mi">1</span> <span class="c1"># decrement number of cases running</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Tried to pop case index &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">subToRemoveIndex</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; but could not because it was out of range. Continuing.&#39;</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tStart</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">5.0</span><span class="p">:</span>
                <span class="c1"># every 5 seconds, check the killfile</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">killfileName</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">if</span> <span class="s2">&quot;killiteration_nopostprocess&quot;</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">[</span><span class="n">KillTypeLineNumber</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Killing iteration&quot;</span><span class="p">)</span>
                    <span class="n">iterationKill</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">allCasesDone</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># kill all processes</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">)):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">subs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Killed &#39;</span> <span class="o">+</span> <span class="n">subs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Ended without killing: &#39;</span> <span class="o">+</span> <span class="n">subs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Ended without kill a process whose name we could not retrieve for some reason.&#39;</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="s2">&quot;killrun_nopostprocess&quot;</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">[</span><span class="n">KillTypeLineNumber</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Killing iteration&quot;</span><span class="p">)</span>
                    <span class="n">runKill</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">allCasesDone</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># kill all processes</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">)):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">subs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Killed &#39;</span> <span class="o">+</span> <span class="n">subs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Ended without killing: &#39;</span> <span class="o">+</span> <span class="n">subs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Ended without kill a process whose name we could not retrieve for some reason.&#39;</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tStart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="c1"># reset the timer</span>
                    
                    
        <span class="c1"># at this point, all cases have started</span>
        <span class="n">tStart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All cases have started&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">allCasesDone</span><span class="p">:</span>
            
            <span class="c1"># just keep looping through, figuring out who to remove and/or kill</span>
            <span class="n">subsToRemove</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">)):</span>
                <span class="c1"># figure out which subprocesses to remove</span>
                <span class="k">if</span> <span class="n">subs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># this means that the subprocess ended naturally of its own accord</span>
                    <span class="c1">#logging.info(&#39;Naturally ended?: &#39; + subs[i][2])</span>
                    <span class="n">subsToRemove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">subs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">killtime</span><span class="p">:</span>
                    <span class="c1"># manually end process because it reached our killtime</span>
                    <span class="n">subsToRemove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    
            <span class="n">subsToRemove</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># sort indices of subs to remove from greatest to least so we remove the highest ones first so that pop() doesn&#39;t mess with our ordering</span>
            <span class="k">for</span> <span class="n">subToRemoveIndex</span> <span class="ow">in</span> <span class="n">subsToRemove</span><span class="p">:</span>
                <span class="c1"># remove subprocesses from the subs list</span>
                <span class="c1"># try removing the ones that ended naturally ... doesn&#39;t seem like they should need it, but do it anyway just in case</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">subs</span><span class="p">[</span><span class="n">subToRemoveIndex</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Killed &#39;</span> <span class="o">+</span> <span class="n">subs</span><span class="p">[</span><span class="n">subToRemoveIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Ended without killing: &#39;</span> <span class="o">+</span> <span class="n">subs</span><span class="p">[</span><span class="n">subToRemoveIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Ended without kill a process whose name we could not retrieve for some reason.&#39;</span><span class="p">)</span>
                
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">subs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">subToRemoveIndex</span><span class="p">)</span>
                    <span class="n">nCasesRunning</span> <span class="o">-=</span> <span class="mi">1</span> <span class="c1"># decrement number of cases running</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Tried to pop case index &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">subToRemoveIndex</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; but could not because it was out of range. Continuing.&#39;</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tStart</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">5.0</span><span class="p">:</span>
                <span class="c1"># every 5 seconds, check the killfile</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">killfileName</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">if</span> <span class="s2">&quot;killiteration_nopostprocess&quot;</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">[</span><span class="n">KillTypeLineNumber</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Killing iteration&quot;</span><span class="p">)</span>
                    <span class="n">iterationKill</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># kill all processes</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">)):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">subs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Killed &#39;</span> <span class="o">+</span> <span class="n">subs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Ended without killing: &#39;</span> <span class="o">+</span> <span class="n">subs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Ended without kill a process whose name we could not retrieve for some reason.&#39;</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="s2">&quot;killrun_nopostprocess&quot;</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">[</span><span class="n">KillTypeLineNumber</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Killing iteration&quot;</span><span class="p">)</span>
                    <span class="n">runKill</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># kill all processes</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">)):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">subs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Killed &#39;</span> <span class="o">+</span> <span class="n">subs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Ended without killing: &#39;</span> <span class="o">+</span> <span class="n">subs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Ended without kill a process whose name we could not retrieve for some reason.&#39;</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tStart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="c1"># reset the timer</span>
            <span class="k">if</span> <span class="n">subs</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="c1"># everyone has finished</span>
                <span class="n">allCasesDone</span> <span class="o">=</span> <span class="kc">True</span>
                
        <span class="c1"># what to do if iterationKill or runKill:</span>
        <span class="k">if</span> <span class="n">runKill</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Killing PEATSA&quot;</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">()</span>
        
        <span class="k">return</span></div>

    
<div class="viewcode-block" id="PEATSAoven.execute">
<a class="viewcode-back" href="../PEATSA/PEATSAoven.html#PEATSAoven.PEATSAoven.execute">[docs]</a>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">PEATSAorder</span><span class="p">,</span> <span class="n">PEATSAboxes</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">logging</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Entering the PEATSA oven to run cases for Iteration &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">iteration</span><span class="p">))</span>
        
        
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">emtg_root_directory</span> <span class="o">+</span> <span class="s2">&quot;/PyEMTG&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">emtg_root_directory</span> <span class="o">+</span> <span class="s2">&quot;/PyEMTG/PEATSA&quot;</span><span class="p">)</span>
        
        <span class="kn">import</span> <span class="nn">subprocess</span>
        <span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
        <span class="kn">from</span> <span class="nn">multiprocessing.pool</span> <span class="kn">import</span> <span class="n">ThreadPool</span>
        <span class="c1">#import MissionOptions</span>
        <span class="kn">import</span> <span class="nn">PEATSAbox</span>

        <span class="c1"># Write out an iteration kill file</span>
        <span class="n">killfileName</span> <span class="o">=</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">+</span> <span class="s2">&quot;PEATSA_iteration_kill_file.DEATH&quot;</span>
        <span class="n">killfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">killfileName</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># increment after every \n. Do NOT increment after the final line where the user actually sets the input.</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# This file is used to end an iteration prematurely or an entire PEATSA run.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# The contents of this file are checked every 5 seconds while PEATSA is running EMTG cases.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# The contents of this file are NOT checked while PEATSA is doing python pre/post-processing.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# To change PEATSA behavior, change the value assigned to KillType and save the file.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Valid options for KillType are given below and are case-insensitive.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# None: (default) No effect. PEATSA continues normally.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# KillRun_NoPostProcess: Ends the entire PEATSA run. Does NOT run post-processing routines.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# KillIteration_NoPostProcess: End the current PEATSA iteration, then starts the next PEATSA iteration.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Does NOT run post-processing routines. This is useful if there is a midbake option you would like to have take effect immediately.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;KillType = None&quot;</span><span class="p">)</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="n">devnull</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/dev/null&quot;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;nCores = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">nCores</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">threadPool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">nCores</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1">#threadPool = ThreadPool(mp.cpu_count())</span>
        <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">PEATSAboxes</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">threadPool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">executeSingleRunInParallel</span><span class="p">,</span> <span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">killfileName</span><span class="p">,</span> <span class="n">KillTypeLineNumber</span><span class="p">,</span> <span class="n">devnull</span><span class="p">))</span>
        
        <span class="c1">#logging.info(&#39;past loop&#39;)</span>
        <span class="c1">#while True:</span>
        <span class="c1">#    if x[-1].ready():</span>
        <span class="c1">#        logging.info(&#39;broke&#39;)</span>
        <span class="c1">#        break</span>
        <span class="n">threadPool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;closed&#39;</span><span class="p">)</span>
        <span class="n">threadPool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;joined&#39;</span><span class="p">)</span>
        
        <span class="n">devnull</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="k">return</span></div>

    
<div class="viewcode-block" id="PEATSAoven.pop_and_kill">
<a class="viewcode-back" href="../PEATSA/PEATSAoven.html#PEATSAoven.PEATSAoven.pop_and_kill">[docs]</a>
    <span class="k">def</span> <span class="nf">pop_and_kill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">proclist</span><span class="p">,</span><span class="n">hostCt</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        PEATSAorder : TYPE</span>
<span class="sd">            DESCRIPTION.</span>
<span class="sd">        proclist : TYPE</span>
<span class="sd">            DESCRIPTION.</span>
<span class="sd">        hostCt : TYPE</span>
<span class="sd">            DESCRIPTION.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        Exception</span>
<span class="sd">            DESCRIPTION.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        proclist : TYPE</span>
<span class="sd">            DESCRIPTION.</span>

<span class="sd">        &quot;&quot;&quot;</span>
    
        <span class="kn">import</span> <span class="nn">time</span>
        <span class="kn">import</span> <span class="nn">shutil</span>
        <span class="kn">import</span> <span class="nn">logging</span>
        <span class="kn">import</span> <span class="nn">os</span>
    
        <span class="c1"># Create a list of cases that need to be removed from the process list</span>
        <span class="c1"># ether because they finished successfully, or because they need to be killed</span>
        <span class="n">poplist</span> <span class="o">=</span> <span class="p">[]</span>
    
        <span class="c1"># Create a list of cases that need to be killed</span>
        <span class="n">killlist</span> <span class="o">=</span> <span class="p">[]</span>
    
        <span class="c1"># Loop through the process list</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">proclist</span><span class="p">)):</span>
        
            <span class="c1"># Grab the current process</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="n">proclist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># proc = [subprocess object, start time, case string, host string, host idx]</span>
        
            <span class="k">if</span> <span class="n">proc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># The case is still running</span>
            
                <span class="c1"># Check if it has been running too long</span>
                <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">proc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">killtime</span><span class="p">:</span>
                    <span class="c1"># It has. IT MUST DIE</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Killing: &quot;</span> <span class="o">+</span> <span class="n">proc</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                
                    <span class="c1"># The case needs to be added to the list of cases to remove from the process list and to the kill list</span>
                    <span class="n">poplist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">killlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># It has been running for an appropriate period of time. Keep going</span>
                    <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">proc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># The case has finished successfully</span>
            
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Case Finished: &quot;</span> <span class="o">+</span> <span class="n">proc</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            
                <span class="c1"># Add this to the list of cases to remove from the process list</span>
                <span class="n">poplist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Start time: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">proc</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Emtgopt file: &quot;</span> <span class="o">+</span> <span class="n">proc</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Host: &quot;</span> <span class="o">+</span> <span class="n">proc</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">poplist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="c1"># raise Exception(&quot;Unexpected error. The process is not running, but it didnt end gracefully.&quot;)</span>
    
        <span class="c1"># Loop through all the cases that need to be killed</span>
        <span class="c1"># and MURDER THEM</span>
        <span class="k">for</span> <span class="n">popListIdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">killlist</span><span class="p">)):</span>
            <span class="n">popIdx</span> <span class="o">=</span> <span class="n">killlist</span><span class="p">[</span><span class="n">popListIdx</span><span class="p">]</span>
        
            <span class="c1"># Check if the process is running locally or on another machine</span>
            <span class="k">if</span> <span class="n">proclist</span><span class="p">[</span><span class="n">popIdx</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>
            
                <span class="c1"># Killing processes is a bit messy, so its safest to do so in a try block</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Python subprocess objects have a kill method. use it.</span>
                    <span class="n">proclist</span><span class="p">[</span><span class="n">popIdx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="c1"># If we are here, also log the exception</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Case appears to have finished now, so I cant murder it: &quot;</span> <span class="o">+</span> <span class="n">proclist</span><span class="p">[</span><span class="n">popIdx</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># IF we are not running locally, then the subprocess is ssh, not an emtg process. So we cant kill it directly, we need to </span>
                <span class="c1"># load the process ID, which should have been written to file on the remote server, and then send a system command </span>
                <span class="c1"># to kill it. NOTE: This is not OS safe, but you should not be here if you are just debugging on windows. Dont run</span>
                <span class="c1"># remote cases from a windows machine! </span>
            
                <span class="c1"># Build the results folder location from </span>
                <span class="n">folder_name</span> <span class="o">=</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">results_dir</span> <span class="o">+</span> <span class="n">proclist</span><span class="p">[</span><span class="n">popIdx</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;emtgopt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                <span class="c1"># Open the pid file from the local machine. NOTE: THIS DOESNT WORK IF THERE ISNT SHARED MEMORY!</span>
                <span class="n">pid_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">folder_name</span> <span class="o">+</span> <span class="s2">&quot;/PID.txt&quot;</span><span class="p">)</span>
                <span class="c1"># Read the file to get the process id number</span>
                <span class="n">PIDno</span> <span class="o">=</span> <span class="n">pid_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="c1"># Send out a signal to the remote machine to kill the process</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;ssh &quot;</span> <span class="o">+</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">nCores</span><span class="p">[</span><span class="n">proclist</span><span class="p">[</span><span class="n">popIdx</span><span class="p">][</span><span class="mi">3</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; kill &quot;</span> <span class="o">+</span> <span class="n">PIDno</span><span class="p">)</span>
        
        <span class="c1"># Loop backwards through the cases that we need to remove from the active process list. </span>
        <span class="c1"># I go backwards because then the indexes that we added earlier stay valid as we go. Yes, I admit, </span>
        <span class="c1"># there is almost certainly a better way to do this, but it does work just fine, and it isn&#39;t terribly</span>
        <span class="c1"># complicated</span>
        <span class="k">for</span> <span class="n">popListIdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">poplist</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        
            <span class="c1"># Get the index into the process list from the poplist</span>
            <span class="n">popIdx</span> <span class="o">=</span> <span class="n">poplist</span><span class="p">[</span><span class="o">-</span><span class="n">popListIdx</span><span class="p">]</span>
        
            <span class="c1"># Reduce the number of cases running on this host</span>
            <span class="n">hostCt</span><span class="p">[</span><span class="n">proclist</span><span class="p">[</span><span class="n">popIdx</span><span class="p">][</span><span class="mi">3</span><span class="p">]]</span> <span class="o">-=</span> <span class="mi">1</span>
        
            <span class="c1"># Remove the process from the list</span>
            <span class="n">proclist</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">popIdx</span><span class="p">)</span>
    
        <span class="c1"># Give back the trimmed proclist</span>
        <span class="k">return</span> <span class="n">proclist</span></div>


<div class="viewcode-block" id="PEATSAoven.cook">
<a class="viewcode-back" href="../PEATSA/PEATSAoven.html#PEATSAoven.PEATSAoven.cook">[docs]</a>
    <span class="k">def</span> <span class="nf">cook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">PEATSAboxes</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        PEATSAorder : TYPE</span>
<span class="sd">            DESCRIPTION.</span>
<span class="sd">        PEATSAboxes : TYPE</span>
<span class="sd">            DESCRIPTION.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">emtg_root_directory</span> <span class="o">+</span> <span class="s2">&quot;/PyEMTG&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">emtg_root_directory</span> <span class="o">+</span> <span class="s2">&quot;/PyEMTG/PEATSA&quot;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">MissionOptions</span>
        <span class="kn">import</span> <span class="nn">PEATSAbox</span>
        <span class="kn">import</span> <span class="nn">logging</span>
        <span class="kn">import</span> <span class="nn">subprocess</span> <span class="k">as</span> <span class="nn">sp</span>
        <span class="kn">import</span> <span class="nn">time</span>
    
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Entering the PEATSA oven to run cases for Iteration &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">iteration</span><span class="p">))</span>
    
        <span class="c1"># Write out an iteration kill file</span>
        <span class="n">killfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">+</span> <span class="s2">&quot;PEATSA_iteration_kill_file.DEATH&quot;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># increment after every \n. Do NOT increment after the final line where the user actually sets the input.</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# This file is used to end an iteration prematurely or an entire PEATSA run.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# The contents of this file are checked every 5 seconds while PEATSA is running EMTG cases.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# The contents of this file are NOT checked while PEATSA is doing python pre/post-processing.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# To change PEATSA behavior, change the value assigned to KillType and save the file.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Valid options for KillType are given below and are case-insensitive.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# None: (default) No effect. PEATSA continues normally.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# KillRun_NoPostProcess: Ends the entire PEATSA run. Does NOT run post-processing routines.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# KillIteration_NoPostProcess: End the current PEATSA iteration, then starts the next PEATSA iteration.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Does NOT run post-processing routines. This is useful if there is a midbake option you would like to have take effect immediately.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">KillTypeLineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;KillType = None&quot;</span><span class="p">)</span>
        <span class="n">killfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="n">ctr</span> <span class="o">=</span> <span class="mi">0</span>
    
        <span class="c1"># Create a list of all active processes</span>
        <span class="n">proclist</span> <span class="o">=</span> <span class="p">[]</span>
    
        <span class="c1"># Create a list to count how many cases a given host is running</span>
        <span class="n">hostCt</span> <span class="o">=</span> <span class="p">{}</span>
    
        <span class="c1"># Count the total number of cores available</span>
        <span class="n">totCores</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">nCores</span><span class="p">:</span>
            <span class="n">hostCt</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">host</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
            <span class="n">totCores</span> <span class="o">+=</span> <span class="n">host</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
        <span class="c1"># emtg output is going to go to devnull, so open a write on it</span>
        <span class="n">devnull</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/dev/null&quot;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        
        <span class="c1"># Flag for killing prematurely</span>
        <span class="n">kill_iteration</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># Flag for killing the entire peatsa run</span>
        <span class="n">kill_peatsa</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="n">nPeatsaBoxes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">PEATSAboxes</span><span class="p">)</span>
        <span class="n">nPeatsaBoxesString</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">nPeatsaBoxes</span><span class="p">)</span>
    
        <span class="c1"># Loop through each case</span>
        <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">PEATSAboxes</span><span class="p">:</span>
            <span class="n">PEATSAdough_path</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">PEATSAdough_path</span>
            
            <span class="c1"># increment the counter</span>
            <span class="n">ctr</span> <span class="o">+=</span> <span class="mi">1</span>
           
            <span class="c1"># Check if the number of cases running is greater than or equal to the number</span>
            <span class="c1"># of cores available     </span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">proclist</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">totCores</span><span class="p">:</span>
            
                <span class="c1"># We do not currently have any cores open</span>
            
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proclist</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; cases running&quot;</span><span class="p">)</span>
            
                <span class="c1"># Sleep for a few seconds so that we arent constantly actively looping</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                
                <span class="c1"># open the kill file</span>
                <span class="n">killfile_handle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">+</span> <span class="s2">&quot;PEATSA_iteration_kill_file.DEATH&quot;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">killfileLines</span> <span class="o">=</span> <span class="n">killfile_handle</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="n">killfile_handle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                                
                <span class="c1"># get the lines from the kill file</span>
                <span class="c1"># Note: Since the default text contains the word &#39;kill&#39; in it, the following check will not kill the iteration if the word &#39;Replace&#39; is also contained in the file.</span>
                <span class="k">if</span> <span class="s2">&quot;killiteration_nopostprocess&quot;</span> <span class="ow">in</span> <span class="n">killfileLines</span><span class="p">[</span><span class="n">KillTypeLineNumber</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;User typed &#39;killiteration_nopostprocess&#39; in .DEATH file. Ending iteration.&quot;</span><span class="p">)</span>
                    <span class="n">kill_iteration</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                
                <span class="k">elif</span> <span class="s2">&quot;killrun_nopostprocess&quot;</span> <span class="ow">in</span> <span class="n">killfileLines</span><span class="p">[</span><span class="n">KillTypeLineNumber</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;User typed &#39;killrun_nopostprocess&#39; in .DEATH file. Quitting PEATSA.&quot;</span><span class="p">)</span>
                    <span class="n">kill_iteration</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">kill_peatsa</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                
                            
                <span class="c1"># Check if any cases finished and if any cases need to be killed</span>
                <span class="n">proclist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop_and_kill</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">proclist</span><span class="p">,</span><span class="n">hostCt</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">kill_iteration</span><span class="p">:</span>
                <span class="k">break</span>
            
            <span class="c1"># Loop through all of the hosts available</span>
            <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">nCores</span><span class="p">:</span>
            
                <span class="c1"># Check if this host has idle cores</span>
                <span class="k">if</span> <span class="n">hostCt</span><span class="p">[</span><span class="n">host</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&lt;</span> <span class="n">host</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>    
                    <span class="c1"># It does!                    </span>
                
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting case &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ctr</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; of &quot;</span> <span class="o">+</span> <span class="n">nPeatsaBoxesString</span> <span class="o">+</span> <span class="s2">&quot; [&quot;</span> <span class="o">+</span> <span class="n">host</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span><span class="s2">&quot;]: &quot;</span> <span class="o">+</span> <span class="n">PEATSAdough_path</span><span class="p">)</span>
                
                    <span class="c1"># Add one to the number of cases being run on this host</span>
                    <span class="n">hostCt</span><span class="p">[</span><span class="n">host</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
                
                    <span class="c1"># Starting the case is different depending on if its local or not</span>
                    <span class="k">if</span> <span class="n">host</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>
                        <span class="c1"># It is local. Just start the EMTG process, and add it along with its details to the process list</span>
                        <span class="n">proclist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">sp</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">emtg_root_directory</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">executable_name</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">cases_directory</span> <span class="o">+</span> <span class="n">PEATSAdough_path</span><span class="p">],</span><span class="n">stdout</span><span class="o">=</span><span class="n">devnull</span><span class="p">,</span><span class="n">stderr</span><span class="o">=</span><span class="n">devnull</span><span class="p">),</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span><span class="n">PEATSAdough_path</span><span class="p">,</span> <span class="n">host</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># It is remote. Start the EMTG process on the remote machine by way of ssh, and add it along with its details to the process list</span>
                        <span class="c1"># This is not OS safe, but you shouldnt be kicking off runs remotely from windows.</span>
                        <span class="n">proclist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">sp</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s2">&quot;ssh&quot;</span><span class="p">,</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">nCores</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">emtg_root_directory</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">executable_name</span><span class="p">,</span><span class="n">case</span><span class="p">],</span><span class="n">stdout</span><span class="o">=</span><span class="n">devnull</span><span class="p">,</span><span class="n">stderr</span><span class="o">=</span><span class="n">devnull</span><span class="p">),</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span><span class="n">PEATSAdough_path</span><span class="p">,</span><span class="n">host</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                
                    <span class="c1"># This case has been started, so no need to keep looping through hosts</span>
                    <span class="k">break</span>
        
        
        <span class="k">if</span> <span class="n">kill_iteration</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Killing iteration&quot;</span><span class="p">)</span>
            <span class="c1"># Loop backwards through the cases that we need to remove from the active process list. </span>
            <span class="c1"># I go backwards because then the indexes that we added earlier stay valid as we go. Yes, I admit, </span>
            <span class="c1"># there is almost certainly a better way to do this, but it does work just fine, and it isn&#39;t terribly</span>
            <span class="c1"># complicated</span>
            <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">proclist</span><span class="p">:</span>
                        
                <span class="c1"># Check if the process is running locally or on another machine</span>
                <span class="k">if</span> <span class="n">proc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>
            
                    <span class="c1"># Killing processes is a bit messy, so its safest to do so in a try block</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Python subprocess objects have a kill method. use it.</span>
                        <span class="n">proc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="c1"># If we are here, also log the exception</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Case appears to have finished now, so I cant murder it: &quot;</span> <span class="o">+</span> <span class="n">proc</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># IF we are not running locally, then the subprocess is ssh, not an emtg process. So we cant kill it directly, we need to </span>
                    <span class="c1"># load the process ID, which should have been written to file on the remote server, and then send a system command </span>
                    <span class="c1"># to kill it. NOTE: This is not OS safe, but you should not be here if you are just debugging on windows. Dont run</span>
                    <span class="c1"># remote cases from a windows machine! </span>
            
                    <span class="c1"># Build the results folder location from </span>
                    <span class="n">folder_name</span> <span class="o">=</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">results_dir</span> <span class="o">+</span> <span class="n">proc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;emtgopt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                    <span class="c1"># Open the pid file from the local machine. NOTE: THIS DOESNT WORK IF THERE ISNT SHARED MEMORY!</span>
                    <span class="n">pid_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">folder_name</span> <span class="o">+</span> <span class="s2">&quot;/PID.txt&quot;</span><span class="p">)</span>
                    <span class="c1"># Read the file to get the process id number</span>
                    <span class="n">PIDno</span> <span class="o">=</span> <span class="n">pid_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                    <span class="c1"># Send out a signal to the remote machine to kill the process</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;ssh &quot;</span> <span class="o">+</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">nCores</span><span class="p">[</span><span class="n">proc</span><span class="p">[</span><span class="mi">3</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; kill &quot;</span> <span class="o">+</span> <span class="n">PIDno</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">kill_peatsa</span><span class="p">:</span>
                <span class="n">exit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
                    
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All cases started&quot;</span><span class="p">)</span>
                        
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">proclist</span><span class="p">):</span>    
                
                <span class="c1"># We have kicked off all cases. Now we just need to wait</span>
    
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proclist</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; cases running&quot;</span><span class="p">)</span>
    
                <span class="c1"># Sleep for a few seconds so that we arent constantly actively looping</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                
                <span class="c1"># open the kill file</span>
                <span class="n">killfile_handle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">+</span> <span class="s2">&quot;PEATSA_iteration_kill_file.DEATH&quot;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">killfileLines</span> <span class="o">=</span> <span class="n">killfile_handle</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="n">killfile_handle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                                
                <span class="c1"># get the lines from the kill file</span>
                <span class="c1"># Note: Since the default text contains the word &#39;kill&#39; in it, the following check will not kill the iteration if the word &#39;Replace&#39; is also contained in the file.</span>
                <span class="k">if</span> <span class="s2">&quot;killiteration_nopostprocess&quot;</span> <span class="ow">in</span> <span class="n">killfileLines</span><span class="p">[</span><span class="n">KillTypeLineNumber</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;User typed &#39;killiteration_nopostprocess&#39; in .DEATH file. Ending iteration.&quot;</span><span class="p">)</span>
                    <span class="n">kill_iteration</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1">#break</span>
                
                <span class="k">elif</span> <span class="s2">&quot;killrun_nopostprocess&quot;</span> <span class="ow">in</span> <span class="n">killfileLines</span><span class="p">[</span><span class="n">KillTypeLineNumber</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;User typed &#39;killrun_nopostprocess&#39; in .DEATH file. Quitting PEATSA.&quot;</span><span class="p">)</span>
                    <span class="n">kill_iteration</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">kill_peatsa</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1">#break            </span>
                    
                <span class="k">if</span> <span class="n">kill_iteration</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Killing iteration&quot;</span><span class="p">)</span>
                    <span class="c1"># Loop backwards through the cases that we need to remove from the active process list. </span>
                    <span class="c1"># I go backwards because then the indexes that we added earlier stay valid as we go. Yes, I admit, </span>
                    <span class="c1"># there is almost certainly a better way to do this, but it does work just fine, and it isn&#39;t terribly</span>
                    <span class="c1"># complicated</span>
                    <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">proclist</span><span class="p">:</span>
                        
                        <span class="c1"># Check if the process is running locally or on another machine</span>
                        <span class="k">if</span> <span class="n">proc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>
            
                            <span class="c1"># Killing processes is a bit messy, so its safest to do so in a try block</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># Python subprocess objects have a kill method. use it.</span>
                                <span class="n">proc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="c1"># If we are here, also log the exception</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Case appears to have finished now, so I cant murder it: &quot;</span> <span class="o">+</span> <span class="n">proc</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># IF we are not running locally, then the subprocess is ssh, not an emtg process. So we cant kill it directly, we need to </span>
                            <span class="c1"># load the process ID, which should have been written to file on the remote server, and then send a system command </span>
                            <span class="c1"># to kill it. NOTE: This is not OS safe, but you should not be here if you are just debugging on windows. Dont run</span>
                            <span class="c1"># remote cases from a windows machine! </span>
            
                            <span class="c1"># Build the results folder location from </span>
                            <span class="n">folder_name</span> <span class="o">=</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">results_dir</span> <span class="o">+</span> <span class="n">proc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;emtgopt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                            <span class="c1"># Open the pid file from the local machine. NOTE: THIS DOESNT WORK IF THERE ISNT SHARED MEMORY!</span>
                            <span class="n">pid_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">folder_name</span> <span class="o">+</span> <span class="s2">&quot;/PID.txt&quot;</span><span class="p">)</span>
                            <span class="c1"># Read the file to get the process id number</span>
                            <span class="n">PIDno</span> <span class="o">=</span> <span class="n">pid_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                            <span class="c1"># Send out a signal to the remote machine to kill the process</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;ssh &quot;</span> <span class="o">+</span> <span class="n">PEATSAorder</span><span class="o">.</span><span class="n">nCores</span><span class="p">[</span><span class="n">proc</span><span class="p">[</span><span class="mi">3</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; kill &quot;</span> <span class="o">+</span> <span class="n">PIDno</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">kill_peatsa</span><span class="p">:</span>
                        <span class="n">exit</span><span class="p">()</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Check if any cases finished and if any cases need to be killed</span>
                    <span class="n">proclist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop_and_kill</span><span class="p">(</span><span class="n">PEATSAorder</span><span class="p">,</span><span class="n">proclist</span><span class="p">,</span><span class="n">hostCt</span><span class="p">)</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">EMTG python</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../PyEMTG/index.html">PyEMTG documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PEATSA/index.html">PEATSA documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../OptionsOverhaul/index.html">OptionsOverhaul documentation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Jacob Englander, Donald Ellison, Jeremy Knittel, Noble Hatten.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>